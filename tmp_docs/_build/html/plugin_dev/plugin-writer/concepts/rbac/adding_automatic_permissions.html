<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Adding Automatic Permissions for New Objects &mdash; Pulp Project 3.23.0.dev documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Restricting Viewable Objects" href="queryset_scoping.html" />
    <link rel="prev" title="Defining an Access Policy" href="access_policy.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Pulp Project
          </a>
              <div class="version">
                3.23.0.dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../concepts.html">Concepts and Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../from-pulp-2.html">Changes From Pulp 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../components.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation/index.html">Installation Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../authentication/index.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows/index.html">Workflows and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../plugins.html">Plugins</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Plugin Development</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../../../index.html#plugin-writer-s-guide">Plugin Writer’s Guide</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../../index.html">Plugin Writer’s Guide</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../../planning-guide.html">Plugin Planning Guide</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="../index.html">Plugin Concepts</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#zero-downtime-migrations">Zero-Downtime Migrations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#data-migrations">Data Migrations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../index.html#tasking-system">Tasking System</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../plugin-walkthrough.html">Plugin Walkthrough</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../index.html#plugin-writer-s-reference">Plugin Writer’s Reference</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../index.html#plugin-api-reference">Plugin API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rest_api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../client_bindings.html">Client Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bugs-features.html">Bugs, Feature and Backport Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changes.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../versioning.html">Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../release_process.html">Pulpcore Release Process</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Pulp Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Plugin Development</a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Plugin Writer’s Guide</a></li>
          <li class="breadcrumb-item"><a href="../index.html">Plugin Concepts</a></li>
      <li class="breadcrumb-item active">Adding Automatic Permissions for New Objects</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/plugin_dev/plugin-writer/concepts/rbac/adding_automatic_permissions.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="adding-automatic-permissions-for-new-objects">
<span id="id1"></span><h1>Adding Automatic Permissions for New Objects<a class="headerlink" href="#adding-automatic-permissions-for-new-objects" title="Permalink to this heading">¶</a></h1>
<p>When creating new objects in either viewsets or tasks it’s important to have the right permissions.
It is important that the permissions new objects receive work with the AccessPolicy so that newly
created objects can be authorized by the AccessPolicy as expected. The AccessPolicy statements are
user-configurable and so the permissions to be created for new objects are too. Similar to the
requirements for the AccessPolicy <code class="docutils literal notranslate"><span class="pre">statements</span></code>, plugin writers can define and ship a default
behavior for permissions on new objects, and then users can modify them as needed after migrations
are run.</p>
<section id="defining-new-object-permission-behaviors">
<span id="id2"></span><h2>Defining New Object Permission Behaviors<a class="headerlink" href="#defining-new-object-permission-behaviors" title="Permalink to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">AccessPolicy.creation_hooks</span></code> attribute defines a set of callables that are intended to be
run when new objects are created. These do not run automatically; your models should use the
<code class="docutils literal notranslate"><span class="pre">pulpcore.plugin.models.AutoAddObjPermsMixin</span></code> on the model as described in the
<a class="reference internal" href="#enabling-new-object-permission-creation"><span class="std std-ref">Enabling New Object Permission Creation</span></a> section.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">AccessPolicy.creation_hooks</span></code> attribute is optional because not all AccessPolicy objects
create objects. If no objects are created by an endpoint, there does not need to be a
<code class="docutils literal notranslate"><span class="pre">creation_hooks</span></code> attribute.</p>
<p>Permissions are associated to users via roles.</p>
<p>The most common auto-assignment of roles is to the creator of an object themselves. Here is an
example assigning the <code class="docutils literal notranslate"><span class="pre">&quot;core.task_owner&quot;</span></code> role to the creator of an object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;add_roles_for_object_creator&quot;</span><span class="p">,</span>
    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;core.task_owner&quot;</span><span class="p">]},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another common auto-assignment of roles is to assign to one or more users explicitly. Here is an
example assigning the <code class="docutils literal notranslate"><span class="pre">&quot;core.task_owner&quot;</span></code> role to the users <code class="docutils literal notranslate"><span class="pre">[&quot;alice&quot;,</span> <span class="pre">&quot;bob&quot;]</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;add_roles_for_users&quot;</span><span class="p">,</span>
    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="s2">&quot;core.task_owner&quot;</span><span class="p">,</span>
        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;alice&quot;</span><span class="p">,</span> <span class="s2">&quot;bob&quot;</span><span class="p">],</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>A third common auto-assignment of roles is to assign to one or more groups explicitly. Here is an
example assigning the <code class="docutils literal notranslate"><span class="pre">&quot;core.task_viewer&quot;</span></code> role to the group <code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;add_roles_for_groups&quot;</span><span class="p">,</span>
    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;core.task_viewer&quot;</span><span class="p">],</span>
        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the hooks shipped with pulpcore accept either a single item or list of items for their
arguments like <code class="docutils literal notranslate"><span class="pre">roles</span></code>, <code class="docutils literal notranslate"><span class="pre">users</span></code> or <code class="docutils literal notranslate"><span class="pre">groups</span></code>.</p>
</div>
</section>
<section id="enabling-new-object-permission-creation">
<span id="id3"></span><h2>Enabling New Object Permission Creation<a class="headerlink" href="#enabling-new-object-permission-creation" title="Permalink to this heading">¶</a></h2>
<p>To enable automatic permission creation for an object managed by an AccessPolicy, have your model
use the <code class="docutils literal notranslate"><span class="pre">pulpcore.plugin.models.AutoAddObjPermsMixin</span></code>. See the example below as an example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">AutoAddObjPermsMixin</span><span class="p">):</span>
   <span class="o">...</span>
</pre></div>
</div>
<p>See the docstring below for more information on this mixin.</p>
<dl class="py class">
<dt class="sig sig-object py" id="pulpcore.app.models.access_policy.AutoAddObjPermsMixin">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">pulpcore.app.models.access_policy.</span></span><span class="sig-name descname"><span class="pre">AutoAddObjPermsMixin</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">kwargs</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pulpcore.app.models.access_policy.AutoAddObjPermsMixin" title="Permalink to this definition">¶</a></dt>
<dd><p>A mixin that automatically adds roles based on the <code class="docutils literal notranslate"><span class="pre">creation_hooks</span></code> data.</p>
<p>To use this mixin, your model must support <code class="docutils literal notranslate"><span class="pre">django-lifecycle</span></code>.</p>
<p>This mixin adds an <code class="docutils literal notranslate"><span class="pre">after_create</span></code> hook which properly interprets the <code class="docutils literal notranslate"><span class="pre">creation_hooks</span></code>
data and calls methods also provided by this mixin to add roles.</p>
<p>These mixing are provided by default:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_for_object_creator</span></code> will add the permissions to the creator of the object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_for_users</span></code> will add the permissions for one or more users by name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_for_groups</span></code> will add the permissions for one or more groups by name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_roles_for_object_creator</span></code> will add the roles to the creator of the object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_roles_for_users</span></code> will add the roles for one or more users by name.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">add_roles_for_groups</span></code> will add the roles for one or more groups by name.</p></li>
</ul>
</dd></dl>

</section>
<section id="shipping-a-default-new-object-policy">
<span id="id4"></span><h2>Shipping a Default New Object Policy<a class="headerlink" href="#shipping-a-default-new-object-policy" title="Permalink to this heading">¶</a></h2>
<p>In general, the default recommended is to use the <code class="docutils literal notranslate"><span class="pre">add_roles_for_object_creator</span></code> to assign the
view, change, and delete permissions for the object created. Here is an example of a default policy
like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">DEFAULT_ACCESS_POLICY</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;statements&quot;</span><span class="p">:</span> <span class="o">&lt;...&gt;</span>
    <span class="s2">&quot;creation_hooks&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;add_roles_for_object_creator&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;roles&quot;</span><span class="p">:</span> <span class="s2">&quot;file.fileremote_owner&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">}</span>
<span class="n">LOCKED_ROLES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;file.fileremote_owner&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">&quot;file.view_fileremote&quot;</span><span class="p">,</span> <span class="s2">&quot;file.change_fileremote&quot;</span><span class="p">,</span> <span class="s2">&quot;file.delete_fileremote&quot;</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This effectively creates a “user isolation” policy which aligns with the examples from
<a class="reference internal" href="access_policy.html#shipping-default-access-policy"><span class="std std-ref">Shipping a Default Access Policy</span></a>.</p>
</section>
<section id="defining-custom-new-object-permission-callables">
<span id="id5"></span><h2>Defining Custom New Object Permission Callables<a class="headerlink" href="#defining-custom-new-object-permission-callables" title="Permalink to this heading">¶</a></h2>
<p>Plugin writers can use more than the built-in callables such as <code class="docutils literal notranslate"><span class="pre">add_roles_for_object_creator</span></code> or
<code class="docutils literal notranslate"><span class="pre">add_roles_for_users</span></code> by defining additional methods on the model itself. The callables defined in
the <code class="docutils literal notranslate"><span class="pre">function</span></code> are method names on the Model that need to be registered with
<code class="docutils literal notranslate"><span class="pre">REGISTERED_CREATION_HOOKS</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">AutoAddObjPermsMixin</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">REGISTERED_CREATION_HOOKS</span><span class="p">[</span><span class="s2">&quot;my_custom_callable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">my_custom_callable</span>

    <span class="k">def</span> <span class="nf">my_custom_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pulpcore.app.util</span> <span class="kn">import</span> <span class="n">assign_role</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="n">assign_role</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>  <span class="c1"># self is the object being assigned</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">assign_role</span><span class="p">(</span><span class="n">role</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>  <span class="c1"># self is the object being assigned</span>
</pre></div>
</div>
<p>This would be callable with a configuration like this one:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;function&quot;</span><span class="p">:</span> <span class="s2">&quot;my_custom_callable&quot;</span><span class="p">,</span>
    <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;pulpcore.task_viewer&quot;</span><span class="p">,</span>
        <span class="s2">&quot;users&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bob&quot;</span><span class="p">],</span>
        <span class="s2">&quot;groups&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">parameters</span></code> dict must actually match the creation hooks signature.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="access_policy.html" class="btn btn-neutral float-left" title="Defining an Access Policy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="queryset_scoping.html" class="btn btn-neutral float-right" title="Restricting Viewable Objects" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2012-2023, Pulp Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74748547-2', 'auto');
  ga('send', 'pageview');

</script>


<script>
$( document ).ready( function() {

  // gets version number minus whitespace and bugfix version
  var $version_number = $('.version').text().trim().split('.', 2).join('.')

  // div mirroring the admonition-warning generated by sphinx if added to .rst
  var warning = '\
          <div class="admonition warning"> \
              <p class="first admonition-title">Warning</p> \
              <p class="last">You are looking at the docs for an unsupported version of Pulp. \
               Consider switching to a  \
               <a href="https://pulpproject.org/docs/">supported version</a></p> \
          </div>'

  
  // get JSON from server and load supported_versions
  $.getJSON("https://raw.githubusercontent.com/pulp/pulp-ci/master/ci/config/releases/supported-releases.json" , function(data) {
    if ($.inArray($version_number, data) === -1) {
      $('.rst-content').prepend(warning)
      }
    })
  })
  </script>


</body>
</html>