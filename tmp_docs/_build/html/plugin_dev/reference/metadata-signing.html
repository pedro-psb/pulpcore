<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Metadata Signing &mdash; Pulp Project 3.23.0.dev documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Task Scheduling" href="task-scheduling.html" />
    <link rel="prev" title="Content Protection" href="content-protection.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Pulp Project
          </a>
              <div class="version">
                3.23.0.dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../concepts.html">Concepts and Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../from-pulp-2.html">Changes From Pulp 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../components.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation/index.html">Installation Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authentication/index.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../workflows/index.html">Workflows and Use Cases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">Plugins</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Plugin Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#plugin-writer-s-guide">Plugin Writer’s Guide</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#plugin-writer-s-reference">Plugin Writer’s Reference</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="index.html">Plugin Writing Reference Material</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="object-relationships.html">Object Relationships</a></li>
<li class="toctree-l4"><a class="reference internal" href="how-plugins-work.html">How Plugins Work</a></li>
<li class="toctree-l4"><a class="reference internal" href="error-handling.html">Error Handling</a></li>
<li class="toctree-l4"><a class="reference internal" href="how-to-doc-api.html">Documenting your API</a></li>
<li class="toctree-l4"><a class="reference internal" href="how-to-doc-api.html#openapi-tags">OpenAPI Tags</a></li>
<li class="toctree-l4"><a class="reference internal" href="on-demand-support.html">On-Demand Support</a></li>
<li class="toctree-l4"><a class="reference internal" href="releasing.html">Releasing Your Plugin</a></li>
<li class="toctree-l4"><a class="reference internal" href="content-protection.html">Content Protection</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Metadata Signing</a></li>
<li class="toctree-l4"><a class="reference internal" href="task-scheduling.html">Task Scheduling</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#plugin-api-reference">Plugin API Reference</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../rest_api.html">REST API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../client_bindings.html">Client Bindings</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../bugs-features.html">Bugs, Feature and Backport Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changes.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../versioning.html">Versioning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_process.html">Pulpcore Release Process</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Pulp Project</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Plugin Development</a></li>
          <li class="breadcrumb-item"><a href="index.html">Plugin Writing Reference Material</a></li>
      <li class="breadcrumb-item active">Metadata Signing</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/plugin_dev/reference/metadata-signing.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="metadata-signing">
<span id="id1"></span><h1>Metadata Signing<a class="headerlink" href="#metadata-signing" title="Permalink to this heading">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Content Signing is in tech-preview and may change in backwards incompatible ways in future
releases.</p>
</div>
<p>Plugin writers wishing to enable users to sign metadata need to add a new field <code class="docutils literal notranslate"><span class="pre">metadata_signing_service</span></code>
to their implementation of a repository and/or publication. This field should be exposed to users who consume
content via REST API. The users may afterwards specify which signing service will be used to sign the
metadata when creating a publication.</p>
<p>Every signing service will always be an instance of a subclass of the <code class="docutils literal notranslate"><span class="pre">SigningService</span></code> model. Plugin
writers may either use the existing <code class="docutils literal notranslate"><span class="pre">AsciiArmoredDetachedSigningService</span></code>, or use that as a reference for
writing their own signing service model.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">SigningService</span></code> base class already provides the fully implemented <code class="docutils literal notranslate"><span class="pre">sign()</span></code> method, the signature of
the <code class="docutils literal notranslate"><span class="pre">validate()</span></code> method (which must be implemented by each subclass), and the <code class="docutils literal notranslate"><span class="pre">save()</span></code> method (which
calls the <code class="docutils literal notranslate"><span class="pre">validate()</span></code> method, but is otherwise fully implemented).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">sign()</span></code> function will be calling the provided script to give the administrator the
freedom to define, how the signature is obtained. It is their responsibility to setup the
software or hardware facilities for signing and make the script use them. The plugin writer
however should provide a reasonably easy default script based on e.g. a simple call to <code class="docutils literal notranslate"><span class="pre">gpg</span></code>.</p>
</div>
<p>In order to sign metadata, plugin writers are required to call the <code class="docutils literal notranslate"><span class="pre">sign()</span></code> method of the signing service
being used. This method invokes the signing script (or other executable) which is provided by the
administrator who instantiates a concrete signing service. Instantiating/creating a concrete signing service
will ultimately call the <code class="docutils literal notranslate"><span class="pre">save()</span></code> method, which will in turn call <code class="docutils literal notranslate"><span class="pre">validate()</span></code>. As a result, it is up to
the <code class="docutils literal notranslate"><span class="pre">validate()</span></code> method to ensure the signing service script provided by the administrator actually provides
any signatures, signature files, and return values, as required by the individual <code class="docutils literal notranslate"><span class="pre">SigningService</span></code> subclass.</p>
<p>This is why implementing a signing service model other than <code class="docutils literal notranslate"><span class="pre">AsciiArmoredDetachedSigningService</span></code> simply
requires inheriting from <code class="docutils literal notranslate"><span class="pre">SiginingService</span></code> and then implementing <code class="docutils literal notranslate"><span class="pre">validate()</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The existing <code class="docutils literal notranslate"><span class="pre">AsciiArmoredDetachedSigningService</span></code> requires a signing script that creates a detached
ascii-armored signature file, and prints valid JSON in the following format to stdout:</p>
<blockquote>
<div><p>{“file”: “filename”, “signature”: “filename.asc”}</p>
</div></blockquote>
<p>Here “filename” is a path to the original file that was signed (passed to the signing script by the
<code class="docutils literal notranslate"><span class="pre">sign()</span></code> method), and “filename.asc” is a path to the signature file created by the script.</p>
<p>The script may read the fingerprint of the key it should use for signing, from the
<code class="docutils literal notranslate"><span class="pre">PULP_SIGNING_KEY_FINGERPRINT</span></code> environment variable.
A <code class="docutils literal notranslate"><span class="pre">CORRELATION_ID</span></code> environment variable is also added by default.
It is possible to pass a dictionary of environment variables to the signing script if need be.</p>
<p>The json is converted to a python dict and returned by the <code class="docutils literal notranslate"><span class="pre">sign()</span></code> method. If an error occurs, a
runtime error is raised instead. All of this is enforced by the <code class="docutils literal notranslate"><span class="pre">validate()</span></code> method at the time of
instantiation.</p>
<p>For more information see the corresponding <a class="reference internal" href="../../workflows/signed-metadata.html#configuring-signing"><span class="std std-ref">workflow documentation</span></a>.</p>
</div>
<p>The following procedure may be taken into account for the plugin writers:</p>
<blockquote>
<div><ol class="arabic">
<li><p>Let us assume that a file repository contains the field <code class="docutils literal notranslate"><span class="pre">metadata_signing_service</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_signing_service</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
    <span class="n">AsciiArmoredDetachedSigningService</span><span class="p">,</span>
    <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
    <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
<p>In the serializer, there is also added a corresponding field that serializes <code class="docutils literal notranslate"><span class="pre">metadata_signing_service</span></code>,
like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_signing_service</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">HyperlinkedRelatedField</span><span class="p">(</span>
    <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;A reference to an associated signing service.&quot;</span><span class="p">,</span>
    <span class="n">view_name</span><span class="o">=</span><span class="s2">&quot;signing-services-detail&quot;</span><span class="p">,</span>
    <span class="n">queryset</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">AsciiArmoredDetachedSigningService</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span>
    <span class="n">many</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">allow_null</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Retrieve a desired signing script via the field <code class="docutils literal notranslate"><span class="pre">metadata_signing_service</span></code> stored in the repository:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_signing_service</span> <span class="o">=</span> <span class="n">FileRepository</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">metadata_signing_service</span>
</pre></div>
</div>
<p>A plugin writer can create a new repository with an associated signing service in the following two ways:</p>
<blockquote>
<div><ul>
<li><p>Using Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">signing_service</span> <span class="o">=</span> <span class="n">AsciiArmoredDetachedSigningService</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;sign-metadata&#39;</span><span class="p">)</span>
<span class="n">FileRepository</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">metadata_signing_service</span><span class="o">=</span><span class="n">signing_service</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Using HTTP calls:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>http<span class="w"> </span>POST<span class="w"> </span>:24817/pulp/api/v3/repositories/file/file/<span class="w"> </span><span class="nv">name</span><span class="o">=</span>foo<span class="w"> </span><span class="nv">metadata_signing_service</span><span class="o">=</span>http://localhost:24817/pulp/api/v3/signing-services/5506c8ac-8eae-4f34-bb5a-3bc08f82b088/
</pre></div>
</div>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Sign a file by calling the method <code class="docutils literal notranslate"><span class="pre">sign()</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">signature</span> <span class="o">=</span> <span class="n">metadata_signing_service</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">metadata</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="n">add_to_repository</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">signature</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</div></blockquote>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="content-protection.html" class="btn btn-neutral float-left" title="Content Protection" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="task-scheduling.html" class="btn btn-neutral float-right" title="Task Scheduling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2012-2023, Pulp Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74748547-2', 'auto');
  ga('send', 'pageview');

</script>


<script>
$( document ).ready( function() {

  // gets version number minus whitespace and bugfix version
  var $version_number = $('.version').text().trim().split('.', 2).join('.')

  // div mirroring the admonition-warning generated by sphinx if added to .rst
  var warning = '\
          <div class="admonition warning"> \
              <p class="first admonition-title">Warning</p> \
              <p class="last">You are looking at the docs for an unsupported version of Pulp. \
               Consider switching to a  \
               <a href="https://pulpproject.org/docs/">supported version</a></p> \
          </div>'

  
  // get JSON from server and load supported_versions
  $.getJSON("https://raw.githubusercontent.com/pulp/pulp-ci/master/ci/config/releases/supported-releases.json" , function(data) {
    if ($.inArray($version_number, data) === -1) {
      $('.rst-content').prepend(warning)
      }
    })
  })
  </script>


</body>
</html>